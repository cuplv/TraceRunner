
Auto Tracer for Trace Runner
============================

This sub-repository contains examples on how to use Robotium (https://github.com/RobotiumTech/robotium)
an Android test automation framework, to develop trace generation scripts that can be used to automatically
re-run our Android apps and extract traces. It also contains a collection of python scripts that help drive
the process.

Note: Auto Tracer is not a solution for full automation in trace generation. What it offers is replayability
in trace generation, from UI interaction scripts written by a human being. 

For full automation, stay tuned for the sister sub-repository 'monkeyTracer'.

Quick Overview
==============

This sub-repository contains the following:

  * examples - Folder containing test apps with example auto tracer scripts
  * startEmulator.py - Script that starts and stops a given avd device image
  * launch.py - Script that runs the test app for manual trace collection
  * autoInstrument.py - Script that instruments the test app and resigns both the test app APK and auto tracer APK
  * autoLaunch.py - Script that runs the test app with the auto tracer scripts
  * autoChain.py - Top-level script that optionally starts an emulator, and runs all auto test scripts specified in tracerConfig.ini

The top-level script 'autoChain.py' essentially takes as input, pairs of App and Tracer (Robotium testers) apks. For
each such pairs, the script will instrument the App apk with TraceRunner and resign both apks with your default apk
signing creds. Next it will run the specified list of Robotium tests in the Tracer apk on either an emulator or actual
android device. The final output we are interested in are the traces generated by the instrumented apps.

Using Auto Tracer
=================

Once setup correctly, all you need to do to generate all traces is to run:

```
python autoChain.py
```

But before that, you'll need to make sure you have set somethings up:

* The scripts here will be calling 'android', 'adb' and 'emulator' tools of the android SDK. It will assume that you
  have included folders 'platform-tools' and 'tools' of your android SDK in your class path.

* If you intend to use an android emulator, create a new emulator with avd for Android API 22 (5.1.1). 
  Note: for now, please use an ARM emulator. The instrumented apps doesn't seem to work on an x86 emulator.
  Shawn will figure out why this is so, but till then, stick to ARM.

* You need to get your local dev environment ready for signing android apks. You can do this with the following
  (when asked for a passphrase, use 'password'):
```
mkdir ~/.keystore
cd ~/.keystore
keytool -genkey -v -keystore recompiled.keystore -alias recompiled -keyalg RSA -keysize 2048 -validity 10000
```

* Build TraceRunner, do this simply by running gradle in the 'TraceRunnerRuntimeInstrumentation' sub-directory, i.e.,
```
TraceRunnerRuntimeInstrumentation$ ./gradlew assembleDebug
```

* Configure the config file 'tracerConfig.ini' to suit your local environment. This is the default file that 'autoChain.py' 
  reads off configurations from.

Configuring Auto Tracer
=======================

Auto Tracer's top level script (autoChain.py) reads off your configurations specified in 'tracerConfig.ini'. 
These configurations will ultimately determine where the script retrieve inputs, write intermediate instrumented
app apks to, and write output traces to.

This configuration file is organized in several sections. The section [tracerOptions] accepts the following options:

* startemulator: Indicates if you want the script to spin-up and kill a new emulator, specified by [emulatorOptions]
* input: Full path to the directory containing the input repositories, containing the app apks and tracer apks.
* instrument: Full path to the directory containing the instrumented apps (and accompanying resigned tracer apks)
  generated by running TraceRunner.
* output: Full path to the directory where output traces will be written to.
* androidjars: Full path to the directory containing the Android SDK's Android jar files.

If you choose to have the script start an emulator, it additionally reads of the section [emulatorOptions], with
the following options:

* name: Name of the emulator device to use.
* port: The port number that avd should use.
* sdpath: Path to the SD card image that the emulator will use.
* display: Indicate if you want the emulator window to be displayed.

The 'input' folder simply point to the root of the input directory. To specify the actual test apps which you like to
include in the Auto Tracer's routine, you have to declare a new section as follows:

```
[app:<App Name>]
app: <Name of the App APK>
tracer: <Name of the Tracer (Robotium Tester) APK>
traces: <Comma seperated list of Tester Classes>
```
The script will assume that the apk pairs are located at ```<Input Directory>/<App Name>``` and will write instrumented
apps and traces to ```<Instrument Directory>/<App Name>``` and ```<Output Directory>/<App Name>``` respectively.

Writing Your Own Tracer Scripts
===============================

More information will come, but for now just check out https://github.com/RobotiumTech/robotium .
Auto Tracer scripts are just Robotium tester routines, implement on top of JUnit and the Android instrumentation framework.
We are not interested in running tests on these apps, but rather we are using the robotium scripts to programmatically exercise 
the app functionality and generate traces.


